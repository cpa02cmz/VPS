name: "Free VPS Research + Self‑Improvement"

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  research:
    runs-on: ubuntu-latest
    env:
      OUTPUT_FILE: "free‑vps.md"
      SELF_IMPROVE_FILE: "self_improve.md"
      BRANCH_PREFIX: "automated/free-vps-update"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare prompts
        run: |
          mkdir -p .github/gemini/prompts
          cat > .github/gemini/prompts/search_free_vps.prompt <<'PROMPT'
You are a web researcher. Task: search for credible offers of free VPS (free‑tier, trial, developer credits, academic/community VPS).  
Output as Markdown with:
- Date: YYYY‑MM‑DD  
- Summary header  
- List each offer: Name, URL, what’s free, limits, evidence links/quotes, reliability score (1‑5), verification notes  
- Research‑log: search queries and visited URLs  
If none found, explain why and suggest next steps.
PROMPT

      - name: Run Gemini CLI – Research free VPS
        id: run_research
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            $(cat .github/gemini/prompts/search_free_vps.prompt)
          gemini_model: "gemni-2.5-flash-lite"
          upload_artifacts: false
        env:
          # environment variable if needed
          OUTPUT_PATH: ${{ env.OUTPUT_FILE }}
        run: |
          echo "${{ steps.run_research.outputs.summary }}" > "${OUTPUT_PATH}"

      - name: Run Gemini CLI – Self‑improve analysis
        id: run_self_improve
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are an analyst. Read the following markdown report (free‑vps.md) and output:
            1) Concrete improvements to the research method (queries, sources, verification)  
            2) Suggested prompt variants for next run (2‑3, ≤50 words each)  
            3) Proposed automated test (shell/regex) to detect low‑quality results.
            Report content:
            $(cat ${{ env.OUTPUT_FILE }})
          gemini_model: "gemni-2.5-flash-lite"
          upload_artifacts: false
        env:
          OUTPUT_PATH2: ${{ env.SELF_IMPROVE_FILE }}
        run: |
          echo "${{ steps.run_self_improve.outputs.summary }}" > "${OUTPUT_PATH2}"

      - name: Preview output files
        run: |
          echo "=== ${OUTPUT_FILE} ==="
          head -n 50 "${OUTPUT_FILE}" || true
          echo "=== ${SELF_IMPROVE_FILE} ==="
          head -n 50 "${SELF_IMPROVE_FILE}" || true

      - name: Configure Git user
        run: |
          git config user.name "github‑actions[bot]"
          git config user.email "github‑actions[bot]@users.noreply.github.com"

      - name: Commit & Push if changed
        id: commit_push
        run: |
          BRANCH="${BRANCH_PREFIX}-$(date +%Y%m%d%H%M%S)"
          git checkout -b "$BRANCH"
          git add "${OUTPUT_FILE}" "${SELF_IMPROVE_FILE}"
          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "::set-output name=changed::false"
            exit 0
          else
            git commit -m "chore: update free‑VPS research + self‑improve (automated)"
            git push --set-upstream origin "$BRANCH"
            echo "::set-output name=changed::true"
            echo "::set-output name=branch::$BRANCH"
          fi

      - name: Create Pull Request
        if: steps.commit_push.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.commit_push.outputs.branch }}
          title: "[Automated] Update free‑VPS research + self‑improve"
          body: |
            This PR contains:
            - Updated `${OUTPUT_FILE}` with latest research results  
            - Updated `${SELF_IMPROVE_FILE}` with analysis & suggestions  
            Review, verify the offers list and merge if acceptable.
          labels: automated, bot

      - name: Create Self‑Improve Issue
        if: steps.commit_push.outputs.changed == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const md = fs.readFileSync(process.env.SELF_IMPROVE_FILE, 'utf8');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "[Auto] Self‑Improve suggestions – free‑VPS research",
              body: `Self‑improvement suggestions generated:\n\n${md}`,
              labels: ["self‑improve","automated"]
            });

      - name: Finish
        run: echo "Workflow completed."
