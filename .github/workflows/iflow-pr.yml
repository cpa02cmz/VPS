name: "iFlow - Apply PR Changes"

on:
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to apply (optional)'
        required: false
        type: number
      trigger_apply:
        description: 'Trigger apply for PR (optional)'
        required: false
        type: number

jobs:
  apply_pr_changes:
    if: |
      (github.event_name == 'pull_request_review_comment' &&
       (contains(github.event.comment.body, '@iflow-cli /apply') ||
        github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'workflow_dispatch' && (inputs.trigger_apply || inputs.pr_number))
    concurrency:
      group: ${{ github.workflow }}-apply-${{ github.event.pull_request.number || inputs.pr_number || inputs.trigger_apply || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve PR number
        env:
          INPUT_PR: ${{ inputs.pr_number }}
          INPUT_APPLY: ${{ inputs.trigger_apply }}
        run: |
          set -euo pipefail
          PR_NUMBER=""
          # 1) dari payload event
          if jq -e '.pull_request.number' "$GITHUB_EVENT_PATH" >/dev/null 2>&1; then
            PR_NUMBER="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
          fi
          # 2) dari inputs
          if [[ -z "${PR_NUMBER}" && -n "${INPUT_PR:-}" ]]; then PR_NUMBER="${INPUT_PR}"; fi
          if [[ -z "${PR_NUMBER}" && -n "${INPUT_APPLY:-}" ]]; then PR_NUMBER="${INPUT_APPLY}"; fi
          # 3) validasi
          if [[ -z "${PR_NUMBER}" ]]; then
            echo "PR number is required"; exit 1
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"
          echo "REPOSITORY=${GITHUB_REPOSITORY}" >> "$GITHUB_ENV"

      - name: Validate PR exists
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          set -euo pipefail
          gh pr view "$PR_NUMBER" --json number,title,headRefName,baseRefName >/dev/null

      - name: Apply feedback, resolve threads, request reviews
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          REPOSITORY: ${{ env.REPOSITORY }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Persona
            Repository maintainer. Perform end-to-end PR maintenance.

            ## Context
            - REPOSITORY: ${{ env.REPOSITORY }}
            - PR_NUMBER: ${{ env.PR_NUMBER }}

            ## Objectives
            - Parse the full PR conversation (reviews, comments, suggestions).
            - Apply only explicit, consensus changes (â‰¤20 LOC each).
            - Commit one fix per comment: `fixup: Apply feedback from comment <comment_id>`.
            - Resolve review threads you addressed.
            - If ready, mark PR ready for review (undraft).
            - Re-request previous reviewers.

            ## Actions
            1) Fetch PR metadata and discussion via GitHub API.
            2) Extract actionable edits (exact snippets or line edits). Skip abstract/debated items.
            3) Patch files, commit per item, push to the PR head branch.
            4) Resolve fixed threads (GraphQL `resolveReviewThread`).
            5) Post a single summary comment: applied vs skipped (with reasons).

            ## Merge policy
            - If mergeable now (no conflicts, approvals satisfied, checks green), merge:
              `gh pr merge $PR_NUMBER --squash --delete-branch --body "Merged after applying explicit feedback."`
            - Else, enable auto-merge so GitHub handles the wait:
              `gh pr merge $PR_NUMBER --squash --auto --delete-branch`

            ## Rules
            - Idempotent edits. No CI/deps/config changes.
            - Keep code valid and style-consistent.

      - name: Attempt merge or enable auto-merge (no waiting)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          set -euo pipefail
          # Final attempt without polling
          gh pr ready "$PR_NUMBER" || true
          gh pr merge "$PR_NUMBER" --squash --delete-branch --body "Merged by automation." || \
          gh pr merge "$PR_NUMBER" --squash --auto --delete-branch || \
          gh pr comment "$PR_NUMBER" --body "Auto-merge could not be enabled (branch protection or approval rules). A maintainer may need to adjust settings."

  notify_failure:
    if: always() && (failure() || cancelled())
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            if (process.env.GITHUB_RUN_ATTEMPT === '1') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Workflow Failure: ${context.workflow}`,
                body: `Failed run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                labels: ['automation-error']
              });
            }
        env:
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
