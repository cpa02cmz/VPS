name: "iFlow - Apply PR Changes"

on:
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Optional: pull request number to review/apply'
        required: false
        type: number
      trigger_apply:
        description: 'Manually trigger apply changes for a PR'
        required: false
        type: number

jobs:
  apply_pr_changes:
    if: |
      (github.event_name == 'pull_request_review_comment' &&
       (contains(github.event.comment.body, '@iflow-cli /apply') ||
        github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'workflow_dispatch' && (inputs.trigger_apply || inputs.pr_number))
    concurrency:
      group: ${{ github.workflow }}-apply-${{ github.event.pull_request.number || inputs.pr_number || inputs.trigger_apply || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve PR number
        env:
          EVENT_PR: ${{ github.event.pull_request.number }}
          INPUT_PR: ${{ inputs.pr_number }}
          INPUT_APPLY: ${{ inputs.trigger_apply }}
        run: |
          set -euo pipefail
          PR_NUMBER="${EVENT_PR:-}"
          if [[ -z "${PR_NUMBER}" && -n "${INPUT_PR:-}" ]]; then PR_NUMBER="${INPUT_PR}"; fi
          if [[ -z "${PR_NUMBER}" && -n "${INPUT_APPLY:-}" ]]; then PR_NUMBER="${INPUT_APPLY}"; fi
          if [[ -z "${PR_NUMBER}" ]]; then echo "PR number is required"; exit 1; fi
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"

      - name: Apply Changes from Full Discussion
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Persona
            You are an expert AI software engineer acting as a diligent repository maintainer.

            ## Primary Goal
            Analyze the entire pull request discussion (comments, reviews, suggestions) and apply only the code changes that are explicit, have clear consensus, and require no interpretation.

            ## Step-by-Step Instructions
            1. Review all PR comments and reviews. Identify concrete, unambiguous feedback with snippets or exact instructions.
            2. Include only small, specific changes (<20 LOC) and typo-level fixes. Exclude design debates or ambiguous asks.
            3. Apply each accepted change precisely to the correct file and line.
            4. Create a separate commit per applied feedback with message: `fixup: Apply feedback from comment <comment_id>`.
            5. Push commits to the PR source branch.
            6. Post one summary comment listing applied changes and skipped items with reasons.

            ## Strict Rules
            - Idempotent: never re-apply already applied changes.
            - Keep code valid and style-consistent.
            - Do not modify CI, security, deps, or workflow config.
            - Do not add features or refactors beyond the feedback.

      - name: Wait until PR is mergeable
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          MAX_MINUTES: "120"     # batasi 2 jam
          SLEEP_SECONDS: "20"
        run: |
          set -euo pipefail
          echo "Waiting up to ${MAX_MINUTES} minutes for PR #${PR_NUMBER} to become mergeable..."
          end=$(( $(date +%s) + ${MAX_MINUTES}*60 ))
          while true; do
            json="$(gh pr view "$PR_NUMBER" --json isDraft,mergeable,reviewDecision,mergeStateStatus,commits 2>/dev/null || true)"
            if [[ -z "$json" ]]; then
              echo "Failed to fetch PR state"; sleep "$SLEEP_SECONDS"; continue
            fi

            isDraft=$(jq -r '.isDraft' <<<"$json")
            mergeable=$(jq -r '.mergeable // "UNKNOWN"' <<<"$json")
            review=$(jq -r '.reviewDecision // "null"' <<<"$json")
            check=$(jq -r '.commits[-1].commit.statusCheckRollup.state // "SUCCESS"' <<<"$json")
            mergeState=$(jq -r '.mergeStateStatus // ""' <<<"$json")

            echo "State: draft=$isDraft mergeable=$mergeable review=$review checks=$check mergeState=$mergeState"

            ok_mergeable=false
            [[ "$mergeable" == "MERGEABLE" ]] && ok_mergeable=true

            ok_review=false
            # treat null as OK when no review rules
            [[ "$review" == "APPROVED" || "$review" == "null" ]] && ok_review=true

            ok_checks=false
            [[ "$check" == "SUCCESS" || "$check" == "null" ]] && ok_checks=true

            not_blocked=true
            [[ "$mergeState" == "BLOCKED" ]] && not_blocked=false

            if [[ "$isDraft" == "false" && "$ok_mergeable" == true && "$ok_review" == true && "$ok_checks" == true && "$not_blocked" == true ]]; then
              echo "Ready to merge."
              break
            fi

            if (( $(date +%s) > end )); then
              echo "Timeout while waiting for mergeability."
              exit 1
            fi
            sleep "$SLEEP_SECONDS"
          done

      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          set -euo pipefail
          # Attempt to remove draft if still draft due to race
          gh pr ready "$PR_NUMBER" || true
          # Merge with squash and delete head branch
          gh pr merge "$PR_NUMBER" --squash --delete-branch --body "Merged by automation after checks and approvals."

  notify_failure:
    if: always() && (failure() || cancelled())
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            if (process.env.GITHUB_RUN_ATTEMPT === '1') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Workflow Failure: ${context.workflow}`,
                body: `Failed run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                labels: ['automation-error']
              });
            }
        env:
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
