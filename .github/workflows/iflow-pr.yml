name: "iFlow - Apply PR Changes"

on:
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Optional: pull request number to apply'
        required: false
        type: number
      trigger_apply:
        description: 'Manually trigger apply changes for a PR'
        required: false
        type: number

jobs:
  apply_pr_changes:
    if: |
      (github.event_name == 'pull_request_review_comment' &&
       (contains(github.event.comment.body, '@iflow-cli /apply') ||
        github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'workflow_dispatch' && (inputs.trigger_apply || inputs.pr_number))
    concurrency:
      group: ${{ github.workflow }}-apply-${{ github.event.pull_request.number || inputs.pr_number || inputs.trigger_apply || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve PR number
        env:
          EVENT_PR: ${{ github.event.pull_request.number }}
          INPUT_PR: ${{ inputs.pr_number }}
          INPUT_APPLY: ${{ inputs.trigger_apply }}
        run: |
          set -euo pipefail
          PR_NUMBER="${EVENT_PR:-}"
          [[ -z "${PR_NUMBER}" && -n "${INPUT_PR:-}" ]] && PR_NUMBER="${INPUT_PR}"
          [[ -z "${PR_NUMBER}" && -n "${INPUT_APPLY:-}" ]] && PR_NUMBER="${INPUT_APPLY}"
          [[ -z "${PR_NUMBER}" ]] && { echo "PR number is required"; exit 1; }
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"

      - name: Apply feedback, resolve threads, push
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Persona
            Repository maintainer. Apply explicit PR feedback end-to-end.

            ## Objectives
            - Parse entire PR discussion.
            - Apply only explicit, small changes with clear consensus.
            - Resolve addressed review threads.
            - Re-request prior reviewers if changes were pushed.
            - Attempt merge if all requirements satisfied; else enable auto-merge.

            ## Procedure
            1) Enumerate actionable comments:
               - Include concrete diffs/snippets or exact line edits (<=20 LOC).
               - Exclude abstract or disputed items.
            2) For each actionable item:
               - Patch exact lines.
               - Commit as: `fixup: Apply feedback from comment <comment_id>`
            3) Push to the PR source branch.
            4) Resolve review threads you addressed:
               - Use GraphQL `resolveReviewThread(threadId)` for each thread whose comments were fixed.
            5) Labels and status:
               - Remove labels like `needs-changes` if present, add/update `status/in-progress` as needed.
               - If PR is draft but ready, mark ready (`gh pr ready $PR_NUMBER`).
            6) Re-request reviewers:
               - Get prior reviewers and request review again.
            7) Merge decision:
               - Fetch PR state: draft, mergeable, reviewDecision, statusCheckRollup.
               - If `mergeable==MERGEABLE` AND (reviewDecision==APPROVED OR null) AND checks success:
                 - `gh pr merge $PR_NUMBER --squash --delete-branch --body "Merged after applying explicit feedback."`
               - Else:
                 - `gh pr merge $PR_NUMBER --squash --auto --delete-branch`  # enable auto-merge
            8) Post one summary comment listing:
               - Applied items.
               - Skipped items with reasons.
               - Whether merged now or auto-merge enabled.

            ## Rules
            - Idempotent. Do not reapply existing edits.
            - No config, deps, or CI file changes.
            - Keep code valid and style-consistent.

      - name: Ensure auto-merge or merge now
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          set -euo pipefail
          # Try a direct merge if already mergeable; else enable auto-merge. No waiting.
          info="$(gh pr view "$PR_NUMBER" --json isDraft,mergeable,reviewDecision,commits 2>/dev/null || true)"
          if [[ -n "$info" ]]; then
            draft=$(jq -r '.isDraft' <<<"$info")
            [[ "$draft" == "true" ]] && gh pr ready "$PR_NUMBER" || true
            mergeable=$(jq -r '.mergeable // "UNKNOWN"' <<<"$info")
            review=$(jq -r '.reviewDecision // "null"' <<<"$info")
            checks=$(jq -r '.commits[-1].commit.statusCheckRollup.state // "SUCCESS"' <<<"$info")
            if [[ "$mergeable" == "MERGEABLE" && ( "$review" == "APPROVED" || "$review" == "null" ) && ( "$checks" == "SUCCESS" || "$checks" == "null" ) ]]; then
              gh pr merge "$PR_NUMBER" --squash --delete-branch --body "Merged by automation after applied feedback."
            else
              gh pr merge "$PR_NUMBER" --squash --auto --delete-branch || \
                gh pr comment "$PR_NUMBER" --body "Auto-merge could not be enabled. A maintainer may need to adjust branch protection or approvals."
            fi
          else
            gh pr merge "$PR_NUMBER" --squash --auto --delete-branch || true
          fi
