name: "iFlow - Update Documentation"

on:
  push:
    branches: [main]

jobs:
  update_docs:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare 'doc' branch
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Pastikan main terbaru
          git fetch origin main --depth=2
          MAIN_SHA="$(git rev-parse origin/main || true)"
          PREV_SHA="$(git rev-list origin/main -n 2 | tail -n1 || true)"

          # Buat atau update branch 'doc'
          if git ls-remote --exit-code --heads origin doc >/dev/null 2>&1; then
            git fetch origin doc:refs/remotes/origin/doc
            git checkout -B doc origin/doc
            # Selaraskan basis dengan main
            git merge --no-edit origin/main || true
          else
            git checkout -b doc origin/main
            git push -u origin doc
          fi

          {
            echo "MAIN_SHA=$MAIN_SHA"
            echo "PREV_SHA=$PREV_SHA"
            echo "REPOSITORY=${{ github.repository }}"
            echo "COMMIT_URL=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          } >> "$GITHUB_ENV"

      - name: Update Documentation with iFlow
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPOSITORY: ${{ env.REPOSITORY }}
          MAIN_SHA: ${{ env.MAIN_SHA }}
          PREV_SHA: ${{ env.PREV_SHA }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '3600'
          debug: 'false'
          prompt: |
            ## Persona
            You are an expert AI Technical Writer. Analyze code changes in main and update documentation on the current branch (doc).

            ## Inputs
            - The current working branch is already checked out to `doc`.
            - Compare using:
              - If PREV_SHA exists: `git diff $PREV_SHA $MAIN_SHA`
              - Else: `git show $MAIN_SHA`

            ## Workflow
            1) Analyze the diff from main. Focus on user-facing impact only.
            2) If documentation needs updates, modify files under:
               - README.md
               - docs/**/*.md
               - examples/**
               Maintain existing style and formatting.
            3) Do not create or switch branches. Commit on the current `doc` branch only.
            4) If nothing user-facing changed, exit without committing.

            ## Commit Rules
            - Stage: `git add -A`
            - Commit message: `docs: sync with $MAIN_SHA`
            - Never modify source code outside documentation.

            ## Guardrails
            - No secrets.
            - Keep diffs minimal and accurate.
            - If unsure, skip.

      - name: Commit and push if changed
        run: |
          set -euo pipefail
          if [[ -n "$(git status --porcelain)" ]]; then
            git add -A
            git commit -m "docs: synchronize documentation with $MAIN_SHA"
            echo "DOC_CHANGED=true" >> "$GITHUB_ENV"
          else
            echo "DOC_CHANGED=false" >> "$GITHUB_ENV"
          fi
          git push origin doc

      - name: Open or update PR doc -> main
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          # Cari PR terbuka dari 'doc' ke 'main'
          PR_NUMBER="$(gh pr list --head doc --base main --state open --json number --jq '.[0].number' || true)"

          # Siapkan body dengan ekspansi shell, bukan ekspresi GHA
          BODY=$(cat <<'EOF'
          This PR keeps documentation in sync with recent changes.
          
          - Trigger commit: ${COMMIT_URL}
          - Compared range: ${PREV_SHA:-N/A} .. ${MAIN_SHA}
          
          Files under README.md, docs/**, examples/** may be updated.
          EOF
          )
          BODY="$(eval "echo \"$BODY\"")"

          if [[ -z "${PR_NUMBER}" || "${PR_NUMBER}" == "null" ]]; then
            if [[ "${DOC_CHANGED}" == "true" ]]; then
              gh pr create \
                --head doc \
                --base main \
                --title "docs: Synchronize documentation with recent changes" \
                --body "$BODY"
            else
              echo "No doc changes and no existing PR. Skipping PR creation."
            fi
          else
            gh pr edit "$PR_NUMBER" --body "$BODY"
            echo "Updated existing PR #$PR_NUMBER"
          fi

  notify_failure:
    if: always() && (failure() || cancelled())
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            if (process.env.GITHUB_RUN_ATTEMPT === '1') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Workflow Failure: ${{ github.workflow }}`,
                body: `Failed run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
                labels: ['automation-error']
              });
            }
        env:
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
