name: "iFlow - Custom"

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Optional: issue number to implement'
        required: false
        type: number

jobs:
  Custom:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '/solve')) ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number)
    concurrency:
      group: ${{ github.workflow }}-issue-${{ github.event.issue.number || inputs.issue_number || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Custom
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ github.event.issue.number || inputs.issue_number }}"
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            # Optional override: '/solve #123'
            refnum=$(printf "%s" "${{ github.event.comment.body }}" | grep -Eo '#[0-9]+' | head -1 | tr -d '#') || true
            if [[ -n "${refnum:-}" ]]; then ISSUE_NUMBER="$refnum"; fi
          fi

          if [[ -z "${ISSUE_NUMBER:-}" ]]; then
            echo "Issue number is required"; exit 1
          fi

          data=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER)
          title=$(jq -r '.title // "manual"' <<<"$data")
          body=$(jq -r '.body // ""' <<<"$data")

          {
            echo "ISSUE_NUMBER=$ISSUE_NUMBER"
            echo "REPOSITORY=${{ github.repository }}"
            echo "ISSUE_TITLE<<__EOF__"
            echo "$title"
            echo "__EOF__"
            echo "ISSUE_BODY<<__EOF__"
            echo "$body"
            echo "__EOF__"
          } >> "$GITHUB_ENV"

      - name: Solve Issue
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPOSITORY: ${{ env.REPOSITORY }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Persona
            Anda adalah seorang orkestrator, planner dan manager repositori github ${{ env.REPOSITORY }}. Anda punya akses penuh ke github cli. 
            ## Context
            - REPOSITORY: ${{ env.REPOSITORY }}

            ## Primary Objective
            Bekerjalah secara otonom untuk menjaga repositori tetap efisien, mudah dikelola dan menerapkan standar terbaik github.

            ## Step-by-Step Workflow
            1.  **Initial Planning:**
                - Analisa repositori secara mendalam 
                - Pikirkan, apa yang dapat Anda lakukan?
                - Buat rencana 

            2.  **Implementasi:**
                - Implementasikan rencana Anda step by step.

            3.  **Laporan:**
                - Laporkan di file report.md.
