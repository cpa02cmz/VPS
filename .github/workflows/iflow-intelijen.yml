name: "Iflow - Intelijen"

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  gather_data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch GitHub Actions run history
        run: |
          mkdir -p intel
          gh run list --limit 100 --json number,workflowName,conclusion,createdAt,startedAt,updatedAt,status > intel/gha_runs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Fetch recent open issues
        run: |
          gh issue list --state open --limit 200 --json number,title,labels,createdAt,updatedAt > intel/open_issues.json
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Fetch recent PR history
        run: |
          gh pr list --state all --limit 200 --json number,title,mergedAt,createdAt,closedAt,author > intel/recent_prs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Upload collected data
        uses: actions/upload-artifact@v5
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: intel/

  analyse_and_create_issues:
    needs: gather_data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download data artifacts
        uses: actions/download-artifact@v4
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: ./intel

      - name: Run iFlow CLI Agent for analysis and prioritized non-duplicate issue creation
        uses: iflow-ai/iflow-cli-action@v2.1.0
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "7200"
          prompt: |
            ## ROLE
            You are an autonomous GitHub repository intelligence agent with write-access.

            ## CONTEXT
            - Repository: ${{ github.repository }}
            - CI/CD runs data: ./intel/gha_runs.json
            - Open issues data: ./intel/open_issues.json
            - PR history data: ./intel/recent_prs.json
            - Full repository code base is checked-out and available for deep analysis

            ## TASKS
            1. Deeply analyze the codebase: modules, dependencies, documentation, test coverage gaps, duplication, naming inconsistencies.
            2. Analyze CI/CD logs: identify jobs with frequent failures, long durations (>10 minutes), reruns, unstable workflows.
            3. Analyze issue/PR history: stale issues (open >60 days), PRs closed without merge, recurring bug patterns.
            4. Produce a ranked list (up to 10) of candidate findings with fields:
               - title, body, category_label ∈ {kind/bug,kind/enhancement,kind/documentation,kind/architecture}, priority_label ∈ {priority/critical,priority/high,priority/medium,priority/low}, score ∈ [0..1].
            5. Selection policy (no duplicates):
               - Define normalize(s): lowercase, trim, collapse spaces, remove punctuation, strip prefixes {bug:, fix:, feat:, chore:, docs:, ci:, refactor:}.
               - Build an in-memory set of open issue titles from ./intel/open_issues.json.
               - Also fetch live open titles to avoid staleness:
                 `gh api -X GET search/issues -f q="repo:${GITHUB_REPOSITORY} is:issue is:open" --jq '.items[].title' > /tmp/open_titles.txt`
               - For each candidate in descending score:
                 a) If normalize(candidate.title) equals any normalized open title, mark as duplicate and continue.
                 b) Else run a fuzzy search:
                    `gh issue list --state open --search "in:title ${candidate.title}" --json number,title --jq '.[].title' > /tmp/hits.txt`
                    If any normalized hit equals normalize(candidate.title), mark as duplicate and continue.
                 c) The first non-duplicate is the selection.
               - If all candidates are duplicates:
                 - Pick the best matching existing issue (exact-title match preferred; else first result from the fuzzy search).
                 - Do not create a new issue. Add a comment summarizing your analysis and why it increases priority or adds new context.
            6. Create or comment:
               - Create: `gh issue create --title "<Issue Title>" --body "<Issue body>" --label "<category_label>,<priority_label>"`
               - Comment: `gh issue comment <issue_number> --body "<Short summary of added insights and next steps>"`
               - Ensure labels exist or mention label creation need in the body.
            7. For improvements that require workflow/config change: output unified-diff targeting `.github/workflows/` or config files and commit or open PR if safe.
            8. Write trace to `intel/issue_selection.json`:
               `{ "chosen_title": "...", "action": "created|commented|skipped", "duplicate_candidates": ["..."], "timestamp": "<ISO8601>" }`
            9. Self-improvement plan: propose added data, thresholds, prompt refinements, save to `intel/self_improvement_plan.md`.

            ## RULES
            - Do not expose or log any secrets.
            - Changes must be small, atomic, maintainable.

        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Save self-improvement plan as artifact
        run: |
          if [ -f intel/self_improvement_plan.md ]; then
            gh release create "self-improvement-${{ github.run_id }}" intel/self_improvement_plan.md --draft --notes "Self-improvement plan generated by iFlow agent"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
